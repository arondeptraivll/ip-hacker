<!-- file: public/index.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool By Gemlogin Tool</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- C·∫¢I TI·∫æN: H·ªôp tho·∫°i nh·∫≠p Key -->
    <div id="key-overlay" class="overlay">
        <div class="modal">
            <h2>Y√™u c·∫ßu x√°c th·ª±c</h2>
            <p>Vui l√≤ng nh·∫≠p KEY ƒë·ªÉ s·ª≠ d·ª•ng c√¥ng c·ª•.</p>
            <input type="text" id="key-input" placeholder="Nh·∫≠p key c·ªßa b·∫°n...">
            <button id="key-submit-btn">X√°c nh·∫≠n</button>
            <div id="key-error" class="notification error" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- C·∫¢I TI·∫æN: H·ªôp tho·∫°i th√¥ng b√°o -->
    <div id="intro-overlay" class="overlay" style="display: none;">
        <div class="modal">
            <h2>Tool by Gemlogin tool</h2>
            <p class="modal-content-intro">M·∫•y con l·ª£n d√πng app n√†y ƒë·ªÉ t√¨m v·ªã tr√≠ crush √† üòâ</p>
            <button id="intro-confirm-btn" disabled>ƒê·ªìng √Ω (<span id="countdown">10</span>)</button>
        </div>
    </div>

    <!-- N·ªôi dung ch√≠nh c·ªßa trang web -->
    <div class="main-container">
        <nav class="navigation">
            <button class="nav-button active" data-page="page-create">T·∫°o Link</button>
            <button class="nav-button" data-page="page-results">Ki·ªÉm Tra Link</button>
        </nav>
        <div id="page-create" class="page-content">
            <h2>T·∫°o li√™n k·∫øt theo d√µi m·ªõi</h2>
            <p>Nh·∫≠p li√™n k·∫øt ƒë√≠ch b·∫°n mu·ªën ng∆∞·ªùi d√πng ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn sau khi nh·∫•p.</p>
            <label for="destination-url">Li√™n k·∫øt ƒë√≠ch (b·∫Øt bu·ªôc):</label>
            <input type="url" id="destination-url" placeholder="https://youtube.com/@Gemlogin" required>
            <button id="create-link-btn">T·∫°o li√™n k·∫øt!</button>
            <div class="loader" id="create-loader"></div>
            <div id="create-result" class="result-box" style="display:none;"></div>
        </div>
        <div id="page-results" class="page-content" style="display: none;">
            <h2>Ki·ªÉm tra k·∫øt qu·∫£ theo d√µi</h2>
            <p>Nh·∫≠p m√£ b√≠ m·∫≠t c·ªßa b·∫°n ƒë·ªÉ xem nh·ªØng ai ƒë√£ nh·∫•p v√†o li√™n k·∫øt.</p>
            <label for="tracking-code-input">M√£ b√≠ m·∫≠t:</label>
            <input type="text" id="tracking-code-input" placeholder="D√°n m√£ b√≠ m·∫≠t v√†o ƒë√¢y" />
            <button id="view-results-btn">Xem k·∫øt qu·∫£</button>
            <div class="loader" id="view-loader"></div>
            <div id="results-display"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- C·∫¢I TI·∫æN: Logic x√°c th·ª±c KEY & Th√¥ng b√°o ---
    const aaronKey = 'gemlogintooldeptrai';

    const keyOverlay = document.getElementById('key-overlay');
    const introOverlay = document.getElementById('intro-overlay');
    const mainContainer = document.querySelector('.main-container');

    const keyInput = document.getElementById('key-input');
    const keySubmitBtn = document.getElementById('key-submit-btn');
    const keyError = document.getElementById('key-error');

    const introConfirmBtn = document.getElementById('intro-confirm-btn');
    const countdownSpan = document.getElementById('countdown');

    const handleKeySubmit = () => {
        if (keyInput.value.trim() === aaronKey) {
            keyOverlay.style.display = 'none';
            introOverlay.style.display = 'flex';
            startIntroCountdown();
        } else {
            keyError.textContent = 'Sai key r·ªìi th·∫±ng ngu!';
            keyError.style.display = 'block';
        }
    };

    keySubmitBtn.addEventListener('click', handleKeySubmit);
    keyInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            handleKeySubmit();
        }
    });

    const startIntroCountdown = () => {
        let timeLeft = 10;
        introConfirmBtn.disabled = true;

        const countdownInterval = setInterval(() => {
            timeLeft--;
            countdownSpan.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                introConfirmBtn.disabled = false;
                introConfirmBtn.textContent = 'Ok, V√†o vi·ªác!';
            }
        }, 1000);
    };

    introConfirmBtn.addEventListener('click', () => {
        introOverlay.style.display = 'none';
        mainContainer.style.visibility = 'visible'; // Hi·ªÉn th·ªã n·ªôi dung ch√≠nh
        // Ch√®n s·∫µn URL k√™nh Youtube c·ªßa b·∫°n
        document.getElementById('destination-url').value = 'https://www.youtube.com/@GemloginTool1';
    });
    // --- K·∫øt th√∫c Logic x√°c th·ª±c ---


    // --- Logic ch√≠nh c·ªßa ·ª©ng d·ª•ng (gi·ªØ nguy√™n) ---
    const navButtons = document.querySelectorAll('.nav-button');
    const pages = document.querySelectorAll('.page-content');
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            navButtons.forEach(btn => btn.classList.remove('active'));
            pages.forEach(page => page.style.display = 'none');
            button.classList.add('active');
            document.getElementById(button.dataset.page).style.display = 'block';
        });
    });

    const createBtn = document.getElementById('create-link-btn');
    const destinationUrlInput = document.getElementById('destination-url');
    const createResultDiv = document.getElementById('create-result');
    const createLoader = document.getElementById('create-loader');
    createBtn.addEventListener('click', async () => {
        const destinationUrl = destinationUrlInput.value.trim();
        if (!destinationUrl) { alert('Vui l√≤ng nh·∫≠p li√™n k·∫øt ƒë√≠ch.'); return; }
        createBtn.disabled = true;
        createLoader.style.display = 'block';
        createResultDiv.style.display = 'none';
        try {
            const response = await fetch('/api/links', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ destinationUrl })
            });
            const data = await response.json();
            if (response.ok) {
                createResultDiv.innerHTML = `
                    <div class="notification success">
                        <p><b>‚úÖ T·∫°o th√†nh c√¥ng!</b></p>
                        <label>Link ƒë·ªÉ g·ª≠i ƒëi (click ƒë·ªÉ sao ch√©p):</label>
                        <input type="text" value="${data.trackable_link}" readonly onclick="this.select()">
                        <label>M√£ b√≠ m·∫≠t (l∆∞u l·∫°i c·∫©n th·∫≠n):</label>
                        <input type="text" value="${data.tracking_code}" readonly onclick="this.select()">
                    </div>`;
            } else {
                createResultDiv.innerHTML = `<div class="notification error"><b>L·ªói:</b> ${data.error || 'Kh√¥ng th·ªÉ t·∫°o link.'}</div>`;
            }
        } catch (error) { createResultDiv.innerHTML = '<div class="notification error"><b>L·ªói:</b> ƒê√£ c√≥ l·ªói m·∫°ng x·∫£y ra.</div>';
        } finally {
            createResultDiv.style.display = 'block';
            createBtn.disabled = false;
            createLoader.style.display = 'none';
        }
    });

    const viewBtn = document.getElementById('view-results-btn');
    const trackingCodeInput = document.getElementById('tracking-code-input');
    const resultsDisplayDiv = document.getElementById('results-display');
    const viewLoader = document.getElementById('view-loader');
    viewBtn.addEventListener('click', async () => {
        const trackingCode = trackingCodeInput.value.trim();
        if (!trackingCode) { alert('Vui l√≤ng nh·∫≠p m√£ b√≠ m·∫≠t.'); return; }
        viewBtn.disabled = true; viewLoader.style.display = 'block'; resultsDisplayDiv.innerHTML = '';
        try {
            const response = await fetch(`/api/results/${trackingCode}`);
            const data = await response.json();
            if (response.ok) {
                if (data.length === 0) {
                    resultsDisplayDiv.innerHTML = '<p>Ch∆∞a c√≥ ai nh·∫•p v√†o li√™n k·∫øt n√†y.</p>';
                } else {
                    let tableHTML = `
                        <p><b>T·ªïng s·ªë l∆∞·ª£t nh·∫•p: ${data.length}</b></p>
                        <table>
                            <thead>
                                <tr><th>Th·ªùi gian</th><th>IP & V·ªã tr√≠</th><th>Thi·∫øt b·ªã</th><th>Ngu·ªìn truy c·∫≠p</th></tr>
                            </thead>
                            <tbody>`;
                    data.forEach(click => {
                        const mapLink = click.latitude ? `<a href="https://www.google.com/maps?q=${click.latitude},${click.longitude}" target="_blank">Xem b·∫£n ƒë·ªì</a>` : '';
                        const location = `${click.city || 'N/A'}, ${click.country || 'N/A'}`;
                        const referrerLink = click.referrer.startsWith('http')
                            ? `<a href="${click.referrer}" target="_blank" title="${click.referrer}">${new URL(click.referrer).hostname}</a>`
                            : click.referrer;
                        tableHTML += `
                            <tr>
                                <td>${new Date(click.timestamp).toLocaleString('vi-VN')}</td>
                                <td>${click.ip_address}<br><small>${location} ${mapLink}</small></td>
                                <td title="${click.user_agent}">${click.user_agent.substring(0, 35)}...</td>
                                <td class="referrer">${referrerLink}</td>
                            </tr>`;
                    });
                    tableHTML += `</tbody></table>`;
                    resultsDisplayDiv.innerHTML = tableHTML;
                }
            } else { resultsDisplayDiv.innerHTML = `<div class="notification error"><b>L·ªói:</b> ${data.error || 'M√£ kh√¥ng h·ª£p l·ªá ho·∫∑c c√≥ l·ªói x·∫£y ra.'}</div>`; }
        } catch (error) { resultsDisplayDiv.innerHTML = '<div class="notification error"><b>L·ªói:</b> ƒê√£ c√≥ l·ªói m·∫°ng khi k·∫øt n·ªëi.</div>'; }
        finally { viewBtn.disabled = false; viewLoader.style.display = 'none'; }
    });
});
</script>

</body>
</html>
